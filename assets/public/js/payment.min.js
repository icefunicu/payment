/**
 * 支付页面
 */
console.log('payment version 3.2.4')
var Payment = (function () {

    this.State = 'NEW';
    /**
     * 订单状态
     */
    OrderState = {
        /**
         * 新生成
         */
        NEW: 0,
        /**
         * 正在支付
         */
        PAYING: 1,
        /**
         * 支付完成 [回调通知中.]
         */
        PAYED: 2,
        /**
         * 通知成功
         */
        SUCCESS: 4,
        /**
         * 通知失败
         */
        FAILURE: 8,
        /**
         * 放弃支付
         */
        WAIVE: 16,
        /**
         * 超时未支付
         */
        TIMEOUT: 32
    };



    /**
     * 展示支付页面
     * @param {string} oid 订单号
     */
    this.Start = function (oid) {
        var that = this;
        that.State = OrderState.NEW;//当前页面的支付状态 
        var audio = that.Audio('/audio/pay.mp3', false);//提示语音
        that.Ajax('order/genre', { oid: oid }, function (order) {
            if (order.error) {
                $('#pay-body').hide();
                $('.error-title').html(order.title);
                $('.error-message').html(order.message);
                $('.error-tip').show().addClass(order.color);
                return;
            }
            //公用参数展示
            $('#pay-money-text').text(order.money);//金额
            $('#pay-order-number').text(order.number);//订单号
            // 有订单标题
            if (order.orderTitle) {
                window.document.title = order.orderTitle;
                $('#pay-order-title-text').text(order.orderTitle);
                $('#pay-order-title').show();
            }
            // 有客服QQ等联系方式时 展示
            if (order.orderService) {
                $('#pay-customer').show();
                $('#pay-customer-phone').text(order.orderService);
            }
            //展示实际内容
            $('#pay-body').removeClass('loading').css({ 'height': 'auto' });//转载好页面后 显示
            $('#pay-body-title').show();
            //设置logo图片 提示信息等
            $('#pay-transfer-text').text(order.type);
            $('#pay-qrcodr-app').text(order.type);
            that.Logo('/public/pays/' + order.type + '.png');
            //依据不同支付方式 展示不同页面
            switch (order.genre) {
                case '扫码':
                    that.Show_QRCode(order, oid);
                    break;
                case '转账':
                    that.Show_Transfer(order, oid);
                    break;
                case '上游处理':
                    break;
            }
            //播放提示语音
            $(document.body).one('click', function () {
                if (that.State == OrderState.NEW) {
                    audio.play();
                }
            })

        })
    }
    /** 
     * 检查订单状态
     */
    this.CheckState = function (oid) {
        var that = this;
        if (this.State == OrderState.TIMEOUT ||//订单超时
            this.State == OrderState.PAYED) { //订单已付款
            //超时 或已付款订单 不需要继续检查状态
            return;
        }
        this.Ajax('order/state', { oid }, function (res) {
            that.State = res.state;
            if (that.State == OrderState.PAYED) {
                that.Alert('订单支付成功', '付款成功', function () {
                    window.location.replace('order/return?oid=' + oid);
                });
            } else if (that.State == OrderState.TIMEOUT) {
                that.Alert('订单支付成功', '付款成功', function () {
                    window.location.replace('order/return?oid=' + oid);
                });
            } else {
                setTimeout(function () {
                    that.CheckState(oid);
                }, 900);
            }

        })
    }
    /**
     * 展示转账汇款界面
     * @param {*} order 
     */
    this.Show_Transfer = function (order, oid) {
        var that = this;
        $('#pay-transfer-number').text(order.transfer);
        $('#pay-type-transfer').show();
        $('#pay-transfer-success').off('click').on('click', function () {
            that.Confirm('是否已完成转账?', '转账确认');
        });
    }
    /**
     * 展示 扫码支付 界面
     */
    this.Show_QRCode = function (order, oid) {
        var that = this;
        $('#pay-qr-image').attr({ 'src': '/cgi-bin/qr-data?data=' + order.qr_data });
        that.CheckState(oid);
        //参数设置完成后 展示页面
        $('#pay-type-qrcode').show();
        that.Countdown(order.EndTime, function (date) {
            $('#pay-countdown-text').text(`${date.minute}分${date.second}秒`);
            if (date.isEnd) {
                $('#pay-qr-image').attr({ src: '/public/images/qrcode_timeout.png' });
                that.State = OrderState.TIMEOUT;//设置为超时状态
                //提示订单过期
                that.Alert('订单已过期,请勿继续支付', '订单过期', function () {
                    console.log('跳转会指定页面')
                });
            }
        })
    }


    /**
     * 设置收银台Logo
     * @param {string} path 图片路径
     */
    this.Logo = function (path) {
        $('#pay-image-logo').attr({ src: path })
    }
    /**
     * 打印日志
     * @param {string} str 日志信息
     */
    this.Log = function (str, ...args) {
        console.log(str, args)
    }

    /**
     * 倒计时剩余
     * @param {Date} time 倒计时结束时间
     * @param {function} func 回调函数
     */
    this.Countdown = function (time, func) {
        if (this.State == OrderState.TIMEOUT || this.State == OrderState.PAYED || this.State == OrderState.SUCCESS) {
            return;
        }
        var date = new Date(time - Date.now());
        //console.log('date:::',date.getTime())

        if (date.getTime() > 999) {
            func({
                minute: Array(2).join('0' + date.getMinutes()).slice(-2),
                second: Array(2).join('0' + date.getSeconds()).slice(-2)
            });

            setTimeout(() => {
                this.Countdown(time, func);
            }, 1000);
        } else {
            func({
                minute: '00',
                second: '00',
                isEnd: true
            });
        }
    }
    /**
     * 播放音频文件
     * @param {string} path 音频路径
     */
    this.Audio = function (path, loop = false) {
        var audio = new window.Audio(path);
        audio.loop = loop;
        return {
            play: function () {
                //audio.play();
            },
            pause: function () {
                //audio.pause();
            }
        }
    }
    /**
     * 执行ajax请求
     * @param {string} url 请求地址
     * @param {object} data 请求参数
     * @param {function} func 回调函数
     */
    this.Ajax = function (url, data, func) {
        $.ajax({
            type: 'POST',
            dataType: 'json',
            data: data,
            url: url,
            success: function (res) {
                func(res)
            }
        })
    }
    /**
     * 提示框
     * @param {string} msg 显示的消息
     * @param {string} title 标题栏
     * @param {function} func 回调函数
     */
    this.Alert = function (msg, title, func) {
        var $modal = $('<div></div>').appendTo(document.body);
        $modal.modal({
            class: 'mini',
            title: title,
            closable: false,
            closeIcon: true,
            blurring: true,
            content: msg,
            actions: [
                {
                    text: '确定',
                    class: 'green mini',
                    icon: 'check',
                    click: function () {
                        if (typeof (func) == 'function') {
                            func();
                        }
                    }
                }]
        }).modal('show')
    }
    /**
     * 问询对话框
     * @param {string} msg 显示的消息
     * @param {string} title 标题栏
     * @param {function} func 回调函数
     */
    this.Confirm = function (msg, title, func) {
        var $modal = $('<div></div>').appendTo(document.body);
        $modal.modal({
            class: 'mini',
            title: title,
            closable: false,
            closeIcon: true,
            blurring: true,
            content: msg,
            actions: [{
                text: '取消',
                class: 'red mini',
                icon: 'cancel',
            },
            {
                text: '确定',
                class: 'green mini',
                icon: 'check',
                click: function () {
                    if (typeof (func) == 'function') {
                        func();
                    }
                }
            }]
        }).modal('show')
    }
})

